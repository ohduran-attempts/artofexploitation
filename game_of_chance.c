#include <stdio.h>
#include <string.h>
#include <fcntl.h>
#include <sys/stat.h>
#include <stdlib.h>
#include "hacking.h"

#ifndef DATAFILE
#define DATAFILE "/var/chance.data"  // File to store user data
#endif


// User struct
struct user{
  int uid;
  int credits;
  int highscore;
  char name[100];
  int (*current_game)();
}

// function prototypes
int get_player_data();
void register_new_player();
void update_player_data();
void show_highscore();
void jackpot();
void input_name();
void print_cards(char *, char *, int);
int take_wager(int, int);
void play_the_game();
int pick_a_number();
int dealer_no_match();
int find_the_ace();
void fata(char *);


// global variables
struct user player;

int main(int argc, char const *argv[]) {
  int choice, last_game;

  srand(time(0)); // Seed the randomize with the current time

  // Log in new player if not found
  if(get_player_data() == -1){
    register_new_player();
  }

  while (choice != 7) {
    printf("-=[ Game of Chance Menu]=-\n");
    printf("1 - Play the Pick a Number game\n");
    printf("2 - Play the No Match Dealer game\n");
    printf("1 - Play the Find the Ace game\n");
    printf("1 - View current high score\n");
    printf("1 - Change your user name\n");
    printf("1 - Reset your account at 100 credits\n");
    printf("1 - Quit\n");
    printf("[Name: %s]\n", player.name);
    printf("[You have %u credits]\n", player.credits);


    scanf("%d", &choice);

    // Invalid
    if((choice < 1) || (choice > 7)){
      printf("\n[!!] The number %d is an invalid selection.\n\n", choice);
    }

    // Games
    else if (choice < 4){
      if (choice != last_game) {
        if (choice == 1){
          player.current_game = pick_a_number;
        }
        else if (choice == 2){
          player.current_game = dealer_no_match;
        }
        else {
          player.current_game = find_the_ace;
        }
        last_game = choice;
      }
      play_the_game();
    }

    // High Score
    else if (choice == 4){
      show_highscore();
    }

    // Change username
    else if (choice == 5){
      printf("\nChange user name\n");
      printf("Enter your new name:\n");
      input_name();
      printf("Your name has been changed\n");
    }

    // Reset player
    else if (choice == 6){
      printf("\nYour account has been reset with 100 credits\n");
      player.credits = 100;
    }
  }
  update_player_data();
  printf("\nThanks for playing! Bye.\n");
}


int get_player_data(){
  int fd, uid, read_bytes;
  struct user entry;

  uid = getuid()

  fd = open(DATAFILE, O_RDONLY);
  if(fd == -1){
    return -1
  }

  read_bytes = read(fd, &entry, sizeof(struct user));  // first chunk

  // loop until proper uid is found
  while (entry.uid != uid && read_bytes > 0){
    read_bytes = read(fd, &entry, sizeof(struct user));
  }

  close(fd);

  if(read_bytes < sizeof(struct user)){
    return -1; // end of file was reached
  }
  else {
    player = entry;
    return 1;
  }
}

void register_new_player(){
  inf fd;

  printf("-=-={ New Player Registration}=-=-\n");
  printf("Enter your name: ");
  input_name();

  player.uid = getuid();
  player.highscore = player.credits = 100;

  fd = open(DATAFILE, O_WRONLY|O_CREAT|O_APPEND, S_IRUSR|S_IWUSR);
  if (fd == -1){
    fatal("in register_new_player(), while opening file");
  }
  write(fd, &player, sizeof(struct user));
  close(fd);

  printf("\nWelcome to the Game of Chance %s\n", player.name);
  printf("\nYou have been given %u credits\n", player.credits);
}

void update_player_data(){
  int fd, i, read_uid;
  char burned_byte;

  fd = open(DATAFILE, O_RDWR);

  if(fd == -1){
    fatal("in update_player_data() while opening file");
  }
  read(fd, &read_uid, 4);  // read the uid from the first 4 bytes
}
